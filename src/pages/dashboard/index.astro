---
import { actions } from "astro:actions";
import {
  ChartSpline,
  Copy,
  Funnel,
  Link,
  PencilIcon,
  TrashIcon,
  SearchIcon,
  PlusIcon,
  ChartLine,
  CheckCircle,
} from "lucide-react";
import MainLayout from "@/layouts/MainLayout.astro";
import { Button } from "@/components/ui/button";
import { CreateLink } from "@/components/create-link";

export const prerender = false;

const session = Astro.locals.session;
const user = Astro.locals.user;

if (!user || !session) {
  return Astro.redirect("/");
}

const { data: links } = await Astro.callAction(actions.linkActions.findAll, {
  user,
});

if (!links) {
  throw new Error("Unexpected response from server");
}

const totalClicks = links.reduce((acc, link) => acc + link.clicks, 0);
const activeLinks = links.filter((l) => l.isActive).length;
---

<MainLayout tittleSlug="Dashboard">
  <div class="min-h-screen bg-background">
    <!-- Header -->
    <header
      class="border-b border-border/50 bg-card/50 backdrop-blur-sm sticky top-0 z-10"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <a href="/" class="flex items-center gap-2">
              <div
                class="w-7 h-7 bg-primary rounded-lg flex items-center justify-center"
              >
                <Link />
              </div>
              <span
                class="font-bold text-lg"
                style="font-family: var(--font-sans);">crshort</span
              >
            </a>
            <div class="hidden sm:block w-px h-6 bg-border"></div>
            <h1
              class="text-lg font-semibold hidden sm:block"
              style="font-family: var(--font-sans);"
            >
              Dashboard
            </h1>
          </div>

          <div class="flex items-center gap-3">
            <CreateLink client:load />
            <div
              class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center"
            >
              <span class="text-sm font-medium text-primary"
                >{user.name?.[0] || user.email?.[0] || "U"}</span
              >
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div class="bg-card rounded-xl p-5 border border-border/50">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center"
            >
              <Link />
            </div>
            <div>
              <p class="text-sm text-muted-foreground">Total de links</p>
              <p class="text-2xl font-bold">{links.length}</p>
            </div>
          </div>
        </div>

        <div class="bg-card rounded-xl p-5 border border-border/50">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-accent/10 rounded-lg flex items-center justify-center"
            >
              <ChartLine />
            </div>
            <div>
              <p class="text-sm text-muted-foreground">Total de clics</p>
              <p class="text-2xl font-bold">
                {totalClicks.toLocaleString("es-ES")}
              </p>
            </div>
          </div>
        </div>

        <div class="bg-card rounded-xl p-5 border border-border/50">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-green-500/10 rounded-lg flex items-center justify-center"
            >
              <CheckCircle className="text-primary" />
            </div>
            <div>
              <p class="text-sm text-muted-foreground">Links activos</p>
              <p class="text-2xl font-bold">{activeLinks}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Search & Filters -->
      <div class="flex flex-col sm:flex-row gap-3 mb-6">
        <div class="relative flex-1">
          <SearchIcon
            className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground"
          />
          <input
            type="text"
            placeholder="Buscar por URL o slug..."
            class="w-full h-10 pl-10 pr-4 bg-card border border-border/50 rounded-lg text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50"
          />
        </div>
        <div class="flex gap-2">
          <select
            class="h-10 px-3 bg-card border border-border/50 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50"
          >
            <option value="all">Todos</option>
            <option value="active">Activos</option>
            <option value="inactive">Inactivos</option>
          </select>
          <Button variant="outline" size="icon">
            <Funnel />
          </Button>
        </div>
      </div>

      <!-- Links Table -->
      <div class="bg-card rounded-xl border border-border/50 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-border/50 bg-muted/30">
                <th
                  class="text-left px-4 py-3 text-sm font-medium text-muted-foreground"
                  >Slug</th
                >
                <th
                  class="text-left px-4 py-3 text-sm font-medium text-muted-foreground hidden md:table-cell"
                  >URL destino</th
                >
                <th
                  class="text-center px-4 py-3 text-sm font-medium text-muted-foreground"
                  >Clics</th
                >
                <th
                  class="text-center px-4 py-3 text-sm font-medium text-muted-foreground hidden sm:table-cell"
                  >Estado</th
                >
                <th
                  class="text-right px-4 py-3 text-sm font-medium text-muted-foreground"
                  >Acciones</th
                >
              </tr>
            </thead>
            <tbody>
              {
                links.length === 0 ? (
                  <tr>
                    <td colspan="5" class="px-4 py-12 text-center">
                      <div class="flex flex-col items-center gap-2">
                        <div class="w-12 h-12 bg-muted rounded-full flex items-center justify-center">
                          <Link />
                        </div>
                        <p class="text-muted-foreground">
                          No tienes ningún link todavía
                        </p>
                        <Button size="sm" variant="outline" className="mt-2">
                          Crear tu primer link
                        </Button>
                      </div>
                    </td>
                  </tr>
                ) : (
                  links.map((link) => (
                    <tr class="border-b border-border/30 hover:bg-muted/20 transition-colors">
                      <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                          <a
                            href={`/r/${link.slug}`}
                            class="font-mono text-sm text-primary hover:underline font-medium"
                          >
                            {link.slug}
                          </a>
                          <Button
                            data-slug={link.slug}
                            title="Copiar enlace"
                            variant="ghost"
                            size="icon-sm"
                          >
                            <Copy />
                          </Button>
                        </div>
                        {link.description && (
                          <p class="text-xs text-muted-foreground mt-0.5 truncate max-w-50">
                            {link.description}
                          </p>
                        )}
                      </td>
                      <td class="px-4 py-3 hidden md:table-cell">
                        <a
                          href={link.url}
                          class="text-sm text-muted-foreground hover:text-foreground truncate block max-w-75"
                          title={link.url}
                        >
                          {link.url}
                        </a>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="text-sm font-medium">
                          {link.clicks.toLocaleString("es-ES")}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center hidden sm:table-cell">
                        {link.isActive ? (
                          <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium bg-green-500/10 text-green-600 dark:text-green-400">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full" />
                            Activo
                          </span>
                        ) : (
                          <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium bg-muted text-muted-foreground">
                            <span class="w-1.5 h-1.5 bg-muted-foreground rounded-full" />
                            Inactivo
                          </span>
                        )}
                      </td>
                      <td class="px-4 py-3">
                        <div class="flex items-center justify-end gap-1">
                          <Button
                            className="p-2 hover:bg-muted rounded-lg transition-colors"
                            title="Ver estadísticas"
                            variant="ghost"
                            size="icon"
                          >
                            <ChartSpline />
                          </Button>
                          <Button
                            className="p-2 hover:bg-muted rounded-lg transition-colors"
                            title="Editar"
                            variant="ghost"
                            size="icon"
                          >
                            <PencilIcon />
                          </Button>
                          <Button
                            className="p-2 hover:bg-destructive/10 rounded-lg transition-colors"
                            title="Eliminar"
                            variant="ghost"
                            size="icon"
                          >
                            <TrashIcon className="text-destructive" />
                          </Button>
                        </div>
                      </td>
                    </tr>
                  ))
                )
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      {
        links.length > 0 && (
          <div class="flex items-center justify-between mt-4 text-sm text-muted-foreground">
            <p>
              Mostrando {links.length} de {links.length} links
            </p>
            <div class="flex items-center gap-2">
              <Button variant="outline" size="sm" disabled>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="m15 18-6-6 6-6" />
                </svg>
                Anterior
              </Button>
              <Button variant="outline" size="sm" disabled>
                Siguiente
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="m9 18 6-6-6-6" />
                </svg>
              </Button>
            </div>
          </div>
        )
      }
    </main>
  </div>
</MainLayout>

<style>
  .group:hover .copy-btn {
    opacity: 1;
  }
</style>

<script>
  document.querySelectorAll(".copy-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const slug = (btn as HTMLElement).dataset.slug;
      const url = `${window.location.origin}/r/${slug}`;

      try {
        await navigator.clipboard.writeText(url);
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;
        setTimeout(() => {
          btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
        }, 2000);
      } catch (err) {
        console.error("Failed to copy:", err);
      }
    });
  });
</script>
